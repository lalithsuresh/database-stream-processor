
on: push

jobs:
  build-and-push-image:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Build Docker image
        run: |
          git clone https://github.com/vmware/sql-to-dbsp-compiler sql-to-dbsp-compiler && \
          cd deploy && \
          ./docker.sh

      - name: Run integration tests
        run: |
          docker network create test && \
          docker run --name dbsp -h dbsp --network test -p 8080 -itd dbspmanager && \
          sleep 10 && \
          docker run --name test --network test --rm dbspmanager bash -c "/database-stream-processor/deploy/integration-tests.sh dbsp:8080"